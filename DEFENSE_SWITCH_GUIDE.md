# 防御开关和IP模拟功能使用指南

## 🎯 功能概述

所有攻击测试页面现已支持：
1. **防御开关** - 可以关闭防御系统，查看攻击成功后的真实效果
2. **IP模拟** - 可以模拟不同IP地址发起攻击，测试IP封禁等功能
3. **攻击效果展示** - 防御关闭时，可以看到攻击payload的实际执行结果

## 🛡️ 安全隔离机制

### 靶场环境隔离
- ✅ 所有攻击测试都在**独立的靶场环境**中进行
- ✅ 使用独立的数据表（`VulnerableUser`、`VulnerableFile`）
- ✅ 攻击效果**仅影响靶场数据**，不会影响主站
- ✅ 主站用户数据、系统配置完全隔离

### 防御机制
- 防御**开启**时：检测并拦截攻击，记录为 `blocked=True`
- 防御**关闭**时：不拦截攻击，但仍记录日志为 `blocked=False`
- 所有攻击日志都会被记录到 `AttackLog` 表中

## 📋 使用方法

### 1. SQL注入测试 (`/test_sqli`)

#### 防御开启（默认）
```
查询: admin' OR '1'='1
结果: ⚠️ 攻击被拦截
```

#### 防御关闭
```
查询: admin' OR '1'='1
结果: ✓ 查询成功，返回所有用户（靶场数据）
显示: 🛡️ 防御已关闭 - 攻击未被拦截（靶场环境）
```

#### IP模拟
```
模拟IP: 192.168.1.100
结果: 攻击日志中记录的IP为 192.168.1.100
```

### 2. 命令注入测试 (`/test_cmdi`)

#### 防御开启
```
目标: 127.0.0.1; whoami
结果: ⚠️ 命令注入攻击已被拦截
```

#### 防御关闭
```
目标: 127.0.0.1; whoami
结果: ✓ Ping执行成功（模拟输出，不执行真实命令）
显示: 🛡️ 防御已关闭 - 命令未被拦截（靶场环境）
```

### 3. 目录遍历测试 (`/test_path_traversal`)

#### 防御开启
```
路径: ../../../etc/passwd
结果: ⚠️ 目录遍历攻击已被拦截
```

#### 防御关闭
```
路径: documents/readme.txt
结果: ✓ 文件读取成功（仅允许访问靶场预设文件）
显示: 🛡️ 防御已关闭 - 路径未被拦截（靶场环境）
```

## 🔍 测试场景示例

### 场景1: 测试SQL注入检测
1. 访问 `/test_sqli`
2. 保持防御开启
3. 输入: `admin' OR '1'='1`
4. 点击"执行查询"
5. 观察：攻击被拦截，显示攻击类型和严重程度

### 场景2: 查看SQL注入成功效果
1. 访问 `/test_sqli`
2. **关闭防御开关**
3. 输入: `admin' OR '1'='1`
4. 点击"执行查询"
5. 观察：查询成功，返回靶场数据库中的所有用户

### 场景3: 模拟不同IP攻击
1. 访问任意测试页面
2. 在"模拟IP地址"输入框输入: `10.0.0.50`
3. 执行攻击测试
4. 查看控制台 `/console` 的攻击日志
5. 观察：日志中显示的IP为 `10.0.0.50`

### 场景4: 测试IP封禁
1. 模拟IP `192.168.1.100` 发起多次攻击
2. 在控制台封禁该IP
3. 再次使用该IP发起攻击
4. 观察：攻击被拦截（IP已封禁）

## 📊 攻击日志记录

所有攻击都会被记录到数据库，包含以下信息：
- `ip`: 攻击来源IP（真实或模拟）
- `payload`: 攻击载荷
- `blocked`: 是否被拦截（防御开启=True，关闭=False）
- `attack_type`: 攻击类型（sqli, cmdi, path_traversal等）
- `attack_category`: 攻击分类（injection, access_control等）
- `severity`: 严重程度（critical, high, medium等）
- `target_url`: 目标URL
- `user_agent`: 用户代理
- `timestamp`: 攻击时间

## ⚠️ 重要说明

### 安全性
1. **靶场隔离**：所有攻击测试都在隔离的靶场环境中进行
2. **数据隔离**：靶场使用独立的数据表，不会影响主站数据
3. **仅供学习**：此功能仅用于安全学习和测试，请勿用于非法用途

### 防御关闭的影响
- ✅ 可以看到攻击成功后的真实效果
- ✅ 仍然会记录攻击日志
- ✅ 仅影响靶场数据，不影响主站
- ⚠️ 建议测试完成后重新开启防御

### IP模拟的用途
- 测试不同IP的攻击行为
- 测试IP封禁功能
- 模拟分布式攻击场景
- 生成多样化的攻击日志数据

## 🚀 快速开始

1. **启动应用**
   ```bash
   python run.py
   ```

2. **访问测试页面**
   - SQL注入: http://localhost:5000/test_sqli
   - 命令注入: http://localhost:5000/test_cmdi
   - 目录遍历: http://localhost:5000/test_path_traversal

3. **尝试攻击**
   - 点击payload示例自动填充
   - 调整防御开关查看不同效果
   - 输入模拟IP测试多IP场景

4. **查看结果**
   - 实时查看攻击检测结果
   - 访问控制台查看攻击日志
   - 分析攻击统计数据

## 📈 后续扩展

可以继续添加的功能：
- [ ] XSS攻击测试页面的防御开关
- [ ] 批量攻击模拟（一次发起多个攻击）
- [ ] 攻击重放功能
- [ ] 自定义检测规则
- [ ] 攻击报告导出

---

**提示**: 所有功能都已在后端和前端完整实现，可以立即开始测试！
