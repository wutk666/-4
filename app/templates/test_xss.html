<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>XSS 测试道场 - 三种攻击类型演示</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding: 20px;
      {% if test_bg_url %}
      background-image: url('{{ test_bg_url }}');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      {% endif %}
    }
    .test-card { background: rgba(255,255,255,0.95); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    .test-card h3 { color: #667eea; margin-bottom: 16px; }
    .test-card .badge { font-size: 12px; }
    .result-box { background: #f8f9fa; border-left: 4px solid #667eea; padding: 12px; border-radius: 4px; margin-top: 12px; font-family: monospace; font-size: 13px; }
    .result-box.error { border-left-color: #dc3545; background: #fff5f5; }
    .result-box.success { border-left-color: #28a745; background: #f0fff4; }
    .result-box.blocked { border-left-color: #ffc107; background: #fff8e1; }
    .comment-item { background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
    .comment-item .author { font-weight: 600; color: #667eea; }
    .comment-item .time { font-size: 12px; color: #6c757d; }
    .dom-output { min-height: 60px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-top: 12px; }
    .sandbox-frame { width: 100%; height: 400px; border: 2px solid #dee2e6; border-radius: 8px; margin-top: 12px; }
    .defense-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .defense-status.on { background: #d4edda; color: #155724; }
    .defense-status.off { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container" style="max-width: 1200px;">
    <div class="text-center mb-4">
      <h1 class="text-white mb-2">XSS 攻击测试道场</h1>
      <p class="text-white-50">演示三种常见 XSS 攻击类型及防御效果</p>
    </div>

    <div class="row">
      <div class="col-md-4">
        <div class="test-card">
          <h3><i class="bi bi-arrow-repeat"></i> 反射型 XSS</h3>
          <span class="badge bg-warning text-dark">Reflected XSS</span>
          <p class="small text-muted mt-2">URL 参数直接回显到页面，未经过滤</p>
          
          <div class="mb-3">
            <label class="form-label small">输入搜索关键词</label>
            <input type="text" id="reflectedInput" class="form-control" placeholder='例如: <script>alert("reflected")</script>'>
          </div>
          <button id="reflectedBtn" class="btn btn-primary btn-sm w-100">测试反射型 XSS</button>
          
          <div id="reflectedResult" class="result-box mt-3" style="display:none;"></div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="test-card">
          <h3><i class="bi bi-database"></i> 存储型 XSS</h3>
          <span class="badge bg-danger">Stored XSS</span>
          <p class="small text-muted mt-2">恶意脚本保存到数据库，所有访问者都会受影响</p>
          
          <div class="mb-2">
            <label class="form-label small">作者</label>
            <input type="text" id="storedAuthor" class="form-control form-control-sm" placeholder="匿名" value="测试用户">
          </div>
          <div class="mb-3">
            <label class="form-label small">评论内容</label>
            <textarea id="storedContent" class="form-control" rows="2" placeholder='例如: <img src=x onerror="alert(1)">'></textarea>
          </div>
          <div class="btn-group w-100 mb-2">
            <button id="storedPostBtn" class="btn btn-danger btn-sm">发布评论</button>
            <button id="storedViewBtn" class="btn btn-outline-primary btn-sm">查看靶场</button>
            <button id="storedClearBtn" class="btn btn-outline-danger btn-sm">清空</button>
          </div>
          
          <div id="storedStatus" class="mt-2" style="display:none;"></div>
          <div id="storedComments" class="mt-3" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="test-card">
          <h3><i class="bi bi-code-slash"></i> 基于 DOM 的 XSS</h3>
          <span class="badge bg-info">DOM-based XSS</span>
          <p class="small text-muted mt-2">纯客户端 JavaScript 操作 DOM，不经过服务器</p>
          
          <div class="mb-3">
            <label class="form-label small">输入内容（将直接插入 DOM）</label>
            <input type="text" id="domInput" class="form-control" placeholder='例如: <img src=x onerror="alert(\'DOM XSS\')">'>
          </div>
          <button id="domBtn" class="btn btn-info btn-sm w-100">测试 DOM XSS</button>
          
          <div class="dom-output" id="domOutput">
            <small class="text-muted">输出区域（innerHTML 直接插入）</small>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-4">
      <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm me-2">返回首页</a>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light btn-sm">仪表盘</a>
    </div>
  </div>

  <script>
    // 反射型 XSS 测试
    document.getElementById('reflectedBtn').addEventListener('click', async () => {
      const input = document.getElementById('reflectedInput').value;
      const resultEl = document.getElementById('reflectedResult');
      resultEl.style.display = 'block';
      resultEl.className = 'result-box';
      resultEl.textContent = '测试中...';
      
      try {
        const url = `/xss/reflected?q=${encodeURIComponent(input)}`;
        window.open(url, '_blank');
        resultEl.className = 'result-box success';
        resultEl.textContent = '已在新窗口打开反射型 XSS 测试页面';
      } catch(e) {
        resultEl.className = 'result-box error';
        resultEl.textContent = '错误: ' + e.message;
      }
    });

    // 存储型 XSS 测试
    document.getElementById('storedPostBtn').addEventListener('click', async () => {
      const author = document.getElementById('storedAuthor').value || '匿名';
      const content = document.getElementById('storedContent').value;
      const statusEl = document.getElementById('storedStatus');
      
      if (!content) {
        alert('请输入评论内容');
        return;
      }
      
      try {
        const r = await fetch('/xss/stored', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({author, content})
        });
        
        statusEl.style.display = 'block';
        
        if (r.ok) {
          const data = await r.json();
          statusEl.className = 'result-box success';
          statusEl.innerHTML = '<strong>防御成功！</strong> 恶意内容已被拦截，评论未保存到数据库。';
        } else {
          statusEl.className = 'result-box blocked';
          statusEl.innerHTML = '<strong>防御拦截！</strong> XSS 攻击已被检测并阻止。';
        }
        
        loadStoredComments();
      } catch(e) {
        statusEl.style.display = 'block';
        statusEl.className = 'result-box error';
        statusEl.innerHTML = '<strong>请求失败：</strong> ' + e.message;
      }
    });

    document.getElementById('storedViewBtn').addEventListener('click', () => {
      window.open('/xss/stored/sandbox', '_blank', 'width=800,height=600');
    });
    
    document.getElementById('storedClearBtn').addEventListener('click', async () => {
      if (!confirm('确定清空所有评论？')) return;
      try {
        await fetch('/xss/stored/clear', {method: 'POST'});
        alert('已清空');
        document.getElementById('storedStatus').style.display = 'none';
        loadStoredComments();
      } catch(e) {
        alert('清空失败: ' + e.message);
      }
    });

    async function loadStoredComments() {
      try {
        const r = await fetch('/xss/stored');
        const data = await r.json();
        const container = document.getElementById('storedComments');
        
        if (!data.comments || data.comments.length === 0) {
          container.innerHTML = '<small class="text-muted">暂无评论</small>';
          return;
        }
        
        container.innerHTML = data.comments.map(c => `
          <div class="comment-item">
            <div class="d-flex justify-content-between">
              <span class="author">${escapeHtml(c.author)}</span>
              <span class="time">${new Date(c.timestamp).toLocaleString()}</span>
            </div>
            <div class="mt-1">${escapeHtml(c.content)}</div>
          </div>
        `).join('');
      } catch(e) {
        document.getElementById('storedComments').innerHTML = '<small class="text-danger">加载失败</small>';
      }
    }

    // DOM XSS 测试
    document.getElementById('domBtn').addEventListener('click', () => {
      const input = document.getElementById('domInput').value;
      const output = document.getElementById('domOutput');
      output.innerHTML = input;
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    loadStoredComments();
  </script>
</body>
</html>