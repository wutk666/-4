<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>SQL æ³¨å…¥æµ‹è¯•é¶åœº</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { 
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .attack-card {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .attack-card h3 { color: #f5576c; margin-bottom: 16px; }
    .payload-example {
      background: #f8f9fa;
      border-left: 4px solid #f5576c;
      padding: 12px;
      border-radius: 4px;
      margin: 8px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .payload-example:hover {
      background: #e9ecef;
      transform: translateX(4px);
    }
    .result-box {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      max-height: 400px;
      overflow-y: auto;
    }
    .result-box.blocked {
      border-left: 4px solid #ffc107;
      background: #fff8e1;
    }
    .result-box.success {
      border-left: 4px solid #28a745;
      background: #f0fff4;
    }
    .result-box.error {
      border-left: 4px solid #dc3545;
      background: #fff5f5;
    }
    .user-table {
      width: 100%;
      font-size: 13px;
    }
    .user-table th {
      background: #f8f9fa;
      padding: 8px;
      text-align: left;
    }
    .user-table td {
      padding: 8px;
      border-bottom: 1px solid #dee2e6;
    }
    .badge-category {
      font-size: 11px;
      padding: 4px 8px;
    }
  </style>
</head>
<body>
  <div class="container" style="max-width: 1400px;">
    <div class="text-center mb-4">
      <h1 class="text-white mb-2"><i class="bi bi-database-fill-exclamation"></i> SQL æ³¨å…¥æµ‹è¯•é¶åœº</h1>
      <p class="text-white-50">æµ‹è¯•å„ç§ SQL æ³¨å…¥æ”»å‡»å‘é‡åŠé˜²å¾¡æœºåˆ¶</p>
      <span class="badge bg-danger">ğŸ’‰ æ³¨å…¥ç±»æ”»å‡»</span>
      <span class="badge bg-warning text-dark">ä¸¥é‡ç¨‹åº¦: CRITICAL</span>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="attack-card">
          <h3><i class="bi bi-search"></i> ç”¨æˆ·æŸ¥è¯¢æµ‹è¯•</h3>
          <p class="small text-muted">æ¨¡æ‹Ÿç”¨æˆ·æœç´¢åŠŸèƒ½ï¼Œæµ‹è¯• SQL æ³¨å…¥æ¼æ´</p>
          
          <div class="mb-3">
            <label class="form-label small">ç”¨æˆ·åæœç´¢</label>
            <input type="text" id="searchInput" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·å">
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label small">æ¨¡æ‹ŸIPåœ°å€</label>
              <input type="text" id="simulatedIp" class="form-control form-control-sm" placeholder="ç•™ç©ºä½¿ç”¨çœŸå®IP">
              <small class="text-muted">ä¾‹: 192.168.1.100</small>
            </div>
            <div class="col-md-6">
              <label class="form-label small">é˜²å¾¡å¼€å…³</label>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="defenseSwitch" checked>
                <label class="form-check-label small" for="defenseSwitch">
                  <span id="defenseSwitchLabel">é˜²å¾¡å·²å¼€å¯</span>
                </label>
              </div>
              <small class="text-muted">å…³é—­åå¯æŸ¥çœ‹æ”»å‡»æ•ˆæœ</small>
            </div>
          </div>
          
          <button id="searchBtn" class="btn btn-danger btn-sm w-100 mb-3">
            <i class="bi bi-search"></i> æ‰§è¡ŒæŸ¥è¯¢
          </button>
          
          <div class="mb-3">
            <strong class="small">å¸¸è§ SQL æ³¨å…¥ Payload:</strong>
            <div class="payload-example" data-payload="admin' OR '1'='1">
              <strong>OR 1=1:</strong> admin' OR '1'='1
            </div>
            <div class="payload-example" data-payload="admin' --">
              <strong>æ³¨é‡Šç»•è¿‡:</strong> admin' --
            </div>
            <div class="payload-example" data-payload="' UNION SELECT username,password,email FROM vulnerable_user --">
              <strong>UNION æ³¨å…¥:</strong> ' UNION SELECT username,password,email FROM vulnerable_user --
            </div>
            <div class="payload-example" data-payload="admin' AND '1'='2">
              <strong>AND 1=2:</strong> admin' AND '1'='2
            </div>
            <div class="payload-example" data-payload="'; DROP TABLE vulnerable_user; --">
              <strong>DROP TABLE:</strong> '; DROP TABLE vulnerable_user; --
            </div>
          </div>
          
          <div id="searchResult" class="result-box" style="display:none;"></div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="attack-card">
          <h3><i class="bi bi-shield-check"></i> é˜²å¾¡çŠ¶æ€ç›‘æ§</h3>
          <p class="small text-muted">å®æ—¶æ˜¾ç¤ºæ”»å‡»æ£€æµ‹å’Œæ‹¦æˆªæƒ…å†µ</p>
          
          <div id="defenseStatus" class="alert alert-info">
            <strong>é˜²å¾¡ç³»ç»Ÿ:</strong> <span id="defenseState">ç­‰å¾…æµ‹è¯•...</span>
          </div>
          
          <div class="mb-3">
            <strong class="small">æ”»å‡»æ£€æµ‹è¯¦æƒ…:</strong>
            <div id="attackDetails" class="mt-2" style="font-size: 13px;">
              <p class="text-muted">æš‚æ— æ£€æµ‹è®°å½•</p>
            </div>
          </div>
          
          <div class="mb-3">
            <strong class="small">SQL æ³¨å…¥ç±»å‹åˆ†ç±»:</strong>
            <ul class="small mt-2">
              <li><strong>ç»å…¸æ³¨å…¥:</strong> OR 1=1, AND 1=2</li>
              <li><strong>æ³¨é‡Šç»•è¿‡:</strong> admin' --, admin' #</li>
              <li><strong>UNION æ³¨å…¥:</strong> è”åˆæŸ¥è¯¢è·å–æ•°æ®</li>
              <li><strong>å †å æŸ¥è¯¢:</strong> æ‰§è¡Œå¤šæ¡SQLè¯­å¥</li>
              <li><strong>æ—¶é—´ç›²æ³¨:</strong> SLEEP(), BENCHMARK()</li>
              <li><strong>å¸ƒå°”ç›²æ³¨:</strong> åŸºäºçœŸå‡åˆ¤æ–­</li>
            </ul>
          </div>
        </div>

        <div class="attack-card">
          <h3><i class="bi bi-people"></i> é¶åœºæ•°æ®åº“</h3>
          <button id="viewDbBtn" class="btn btn-outline-primary btn-sm w-100 mb-2">
            <i class="bi bi-eye"></i> æŸ¥çœ‹å®Œæ•´æ•°æ®åº“ï¼ˆé¶åœºï¼‰
          </button>
          <button id="resetDbBtn" class="btn btn-outline-secondary btn-sm w-100">
            <i class="bi bi-arrow-clockwise"></i> é‡ç½®æ•°æ®åº“
          </button>
        </div>
      </div>
    </div>

    <div class="text-center mt-4">
      <a href="{{ url_for('attack_hub') }}" class="btn btn-outline-light btn-sm me-2">è¿”å›æ”»å‡»ä¸­å¿ƒ</a>
      <a href="{{ url_for('console') }}" class="btn btn-outline-light btn-sm">æ§åˆ¶å°</a>
    </div>
  </div>

  <script>
    // é˜²å¾¡å¼€å…³åˆ‡æ¢
    document.getElementById('defenseSwitch').addEventListener('change', (e) => {
      const label = document.getElementById('defenseSwitchLabel');
      if (e.target.checked) {
        label.textContent = 'é˜²å¾¡å·²å¼€å¯';
        label.classList.remove('text-danger');
        label.classList.add('text-success');
      } else {
        label.textContent = 'é˜²å¾¡å·²å…³é—­';
        label.classList.remove('text-success');
        label.classList.add('text-danger');
      }
    });
    
    // ç‚¹å‡»payloadç¤ºä¾‹è‡ªåŠ¨å¡«å……
    document.querySelectorAll('.payload-example').forEach(el => {
      el.addEventListener('click', () => {
        document.getElementById('searchInput').value = el.dataset.payload;
      });
    });

    // æ‰§è¡ŒæŸ¥è¯¢
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const query = document.getElementById('searchInput').value;
      const defenseEnabled = document.getElementById('defenseSwitch').checked;
      const simulatedIp = document.getElementById('simulatedIp').value.trim();
      const resultEl = document.getElementById('searchResult');
      const statusEl = document.getElementById('defenseStatus');
      const detailsEl = document.getElementById('attackDetails');
      const stateEl = document.getElementById('defenseState');
      
      if (!query) {
        alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
        return;
      }
      
      resultEl.style.display = 'block';
      resultEl.className = 'result-box';
      resultEl.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> æŸ¥è¯¢ä¸­...</div>';
      
      try {
        const r = await fetch('/attack/sqli/search', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            query: query,
            defense_enabled: defenseEnabled,
            simulated_ip: simulatedIp
          })
        });
        
        const data = await r.json();
        
        if (data.blocked) {
          resultEl.className = 'result-box blocked';
          statusEl.className = 'alert alert-warning';
          stateEl.innerHTML = '<i class="bi bi-shield-fill-exclamation"></i> æ”»å‡»å·²æ‹¦æˆª';
          
          detailsEl.innerHTML = `
            <div class="alert alert-warning mb-2">
              <strong>æ£€æµ‹åˆ°æ”»å‡»:</strong> ${data.attack_type || 'SQLæ³¨å…¥'}
            </div>
            <div><strong>æ”»å‡»æè¿°:</strong> ${data.description || 'æœªçŸ¥'}</div>
            <div><strong>ä¸¥é‡ç¨‹åº¦:</strong> <span class="badge bg-danger">${data.severity || 'CRITICAL'}</span></div>
            <div><strong>æ”»å‡»åˆ†ç±»:</strong> <span class="badge bg-info">${data.category || 'æ³¨å…¥ç±»æ”»å‡»'}</span></div>
          `;
          
          resultEl.innerHTML = `
            <div class="alert alert-warning">
              <i class="bi bi-shield-exclamation"></i> <strong>SQL æ³¨å…¥æ”»å‡»å·²è¢«æ‹¦æˆªï¼</strong>
            </div>
            <p><strong>æ£€æµ‹åˆ°çš„æ”»å‡»æ¨¡å¼:</strong> ${data.description}</p>
            <p class="text-muted small">æ¶æ„æŸ¥è¯¢å·²è¢«é˜»æ­¢ï¼Œæ•°æ®åº“æœªå—å½±å“ã€‚</p>
          `;
        } else if (data.error) {
          resultEl.className = 'result-box error';
          statusEl.className = 'alert alert-danger';
          stateEl.innerHTML = '<i class="bi bi-x-circle"></i> æŸ¥è¯¢é”™è¯¯';
          
          resultEl.innerHTML = `
            <div class="alert alert-danger">
              <strong>æŸ¥è¯¢å¤±è´¥:</strong> ${data.error}
            </div>
          `;
        } else {
          resultEl.className = 'result-box success';
          statusEl.className = 'alert alert-success';
          stateEl.innerHTML = '<i class="bi bi-check-circle"></i> æŸ¥è¯¢æˆåŠŸ';
          
          // æ˜¾ç¤ºé˜²å¾¡çŠ¶æ€å’ŒIPä¿¡æ¯
          let statusInfo = '';
          if (!data.defense_enabled) {
            statusInfo = '<div class="alert alert-danger mb-2"><i class="bi bi-shield-slash"></i> <strong>é˜²å¾¡å·²å…³é—­</strong> - æ”»å‡»æœªè¢«æ‹¦æˆªï¼ˆé¶åœºç¯å¢ƒï¼‰</div>';
            detailsEl.innerHTML = '<p class="text-warning">âš ï¸ é˜²å¾¡å…³é—­ï¼Œæ”»å‡»payloadå·²æ‰§è¡Œï¼ˆä»…åœ¨é¶åœºå†…ï¼‰</p>';
          } else {
            detailsEl.innerHTML = '<p class="text-success">âœ“ æœªæ£€æµ‹åˆ°æ”»å‡»è¡Œä¸º</p>';
          }
          
          if (data.simulated_ip) {
            statusInfo += `<div class="alert alert-info mb-2"><i class="bi bi-router"></i> æ¨¡æ‹ŸIP: <strong>${data.simulated_ip}</strong></div>`;
          }
          
          if (data.users && data.users.length > 0) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯†ç å­—æ®µï¼ˆSQLæ³¨å…¥æˆåŠŸï¼‰
            const hasPassword = data.users[0].password !== undefined;
            let html = '<table class="user-table"><thead><tr><th>ID</th><th>ç”¨æˆ·å</th><th>é‚®ç®±</th>';
            if (hasPassword) {
              html += '<th class="text-danger">å¯†ç  âš ï¸</th>';
            }
            html += '<th>è§’è‰²</th></tr></thead><tbody>';
            
            data.users.forEach(u => {
              html += `<tr><td>${u.id}</td><td>${u.username}</td><td>${u.email}</td>`;
              if (hasPassword) {
                html += `<td class="text-danger"><code>${u.password}</code></td>`;
              }
              html += `<td><span class="badge bg-secondary">${u.role}</span></td></tr>`;
            });
            html += '</tbody></table>';
            
            let successMsg = hasPassword 
              ? `<div class="alert alert-danger mb-2"><i class="bi bi-exclamation-triangle"></i> <strong>SQLæ³¨å…¥æˆåŠŸï¼</strong> è·å–åˆ° ${data.users.length} æ¡è®°å½•ï¼ˆåŒ…æ‹¬å¯†ç ï¼‰</div>`
              : `<div class="alert alert-success mb-2">æ‰¾åˆ° ${data.users.length} æ¡è®°å½•</div>`;
            
            resultEl.innerHTML = statusInfo + successMsg + html;
          } else {
            resultEl.innerHTML = statusInfo + '<div class="alert alert-info">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</div>';
          }
        }
      } catch(e) {
        resultEl.className = 'result-box error';
        resultEl.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
      }
    });

    // æŸ¥çœ‹å®Œæ•´æ•°æ®åº“
    document.getElementById('viewDbBtn').addEventListener('click', () => {
      window.open('/attack/sqli/sandbox', '_blank', 'width=900,height=700');
    });

    // é‡ç½®æ•°æ®åº“
    document.getElementById('resetDbBtn').addEventListener('click', async () => {
      if (!confirm('ç¡®å®šè¦é‡ç½®é¶åœºæ•°æ®åº“å—ï¼Ÿ')) return;
      try {
        const r = await fetch('/attack/sqli/reset', {method: 'POST'});
        const data = await r.json();
        alert(data.message || 'é‡ç½®æˆåŠŸ');
      } catch(e) {
        alert('é‡ç½®å¤±è´¥: ' + e.message);
      }
    });
  </script>
</body>
</html>
