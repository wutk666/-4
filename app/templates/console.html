<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>控制台 · XSS 防御</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:,">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/console.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    #landingBgOverlay{
      position: fixed;
      inset: 0;
      background: #CCFF00;
      opacity: 0;
      transition: opacity 1.00s ease;
      z-index: 0;
      pointer-events: none;
    }

    body.console-landing-bg #landingBgOverlay{ opacity: 1; }
    body.console-landing-bg-out #landingBgOverlay{ opacity: 0; }

    .console-shell{ position: relative; z-index: 1; }

    body.console-entering .console-shell{
      opacity: 1;
      transform: translateY(6px) scale(1.01);
      filter: blur(12px) saturate(1.02) contrast(1.02);
      will-change: opacity, transform, filter;
    }
    body.console-entered .console-shell{
      opacity: 1;
      transform: translateY(0);
      filter: blur(0px) saturate(1) contrast(1);
      transition: transform 0.42s ease, filter 0.45s ease;
    }
  </style>
</head>

<body>

  <div id="landingBgOverlay" aria-hidden="true"></div>

  <div class="page-flip-overlay" id="pageFlipOverlay" aria-hidden="true">
    <div class="page-flip-dim"></div>
    <div class="page-flip-sheet sheet-1"></div>
    <div class="page-flip-sheet sheet-2"></div>
  </div>

  {% include 'loader_staccato.html' %}

  <script>
    (function initStaccatoEarly(){
      try {
        try {
          if (sessionStorage.getItem('__skipConsoleStaccatoOnce') === '1') {
            sessionStorage.removeItem('__skipConsoleStaccatoOnce');
            window.__skipConsoleOverlayOnce = true;
            try {
              const o = document.getElementById('pageFlipOverlay');
              if (o && o.parentNode) {
                o.parentNode.removeChild(o);
              }
            } catch (e0) {}
            document.body.classList.add('console-landing-bg');
            document.body.classList.add('console-entering');
            requestAnimationFrame(() => {
              try {
                document.body.classList.add('console-entered');
                document.body.classList.remove('console-entering');
              } catch (e2) {}
            });
            setTimeout(() => {
              try { document.body.classList.add('console-landing-bg-out'); } catch (e3) {}
            }, 220);
            setTimeout(() => {
              try {
                document.body.classList.remove('console-landing-bg');
                document.body.classList.remove('console-landing-bg-out');
              } catch (e4) {}
            }, 1500);
            return;
          }
        } catch (e) {}
        window.__stLoaderStart = Date.now();
        if (window.StaccatoLoader && typeof window.StaccatoLoader.show === 'function') {
          window.StaccatoLoader.show();
        }
        if (window.__stLoaderHideTimer) {
          clearTimeout(window.__stLoaderHideTimer);
        }
        window.__stLoaderHideTimer = setTimeout(() => {
          try {
            if (window.StaccatoLoader && typeof window.StaccatoLoader.hide === 'function') {
              window.StaccatoLoader.hide();
            }
          } catch (e) {}
        }, 980);
      } catch (e) {}
    })();
  </script>

  <div class="console-shell">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-mark" id="brandMark" style="background-image:url('{{ url_for('static', filename='img/mascot.jpg') }}');"></div>
        <div>
          <div class="brand-title">XSS Guardian</div>
          <div class="brand-sub">欢迎 {{ user.username }}</div>
        </div>
      </div>

      <div class="nav-section">
        <a class="nav-item active" href="{{ url_for('console') }}">
          <div class="nav-icon"><i class="bi bi-house"></i></div>
          <div>控制台</div>
        </a>
        <a class="nav-item" href="{{ url_for('dashboard') }}">
          <div class="nav-icon"><i class="bi bi-bar-chart"></i></div>
          <div>仪表盘</div>
        </a>
        <a class="nav-item" href="{{ url_for('attack_hub') }}">
          <div class="nav-icon"><i class="bi bi-shield-exclamation"></i></div>
          <div>攻击测试中心</div>
        </a>
        <a class="nav-item" href="{{ url_for('test_xss_page') }}">
          <div class="nav-icon"><i class="bi bi-flask"></i></div>
          <div>XSS 测试</div>
        </a>
        <a class="nav-item" href="{{ url_for('upload_mascot_page') }}">
          <div class="nav-icon"><i class="bi bi-image"></i></div>
          <div>上传吉祥物</div>
        </a>
        <a class="nav-item" href="{{ url_for('upload_test_bg_page') }}">
          <div class="nav-icon"><i class="bi bi-palette"></i></div>
          <div>测试页背景</div>
        </a>
        <a class="nav-item" href="{{ url_for('api_attack_trend') }}">
          <div class="nav-icon"><i class="bi bi-link-45deg"></i></div>
          <div>攻击统计 API</div>
        </a>
        <a class="nav-item" href="{{ url_for('logout') }}">
          <div class="nav-icon"><i class="bi bi-box-arrow-right"></i></div>
          <div>退出</div>
        </a>
      </div>

      <div class="sidebar-footer">
        <div class="user-row">
          <div class="user-meta">
            <div class="user-avatar"></div>
            <div>
              <div class="user-name">{{ user.username }}</div>
              <div class="user-mini">online</div>
            </div>
          </div>
          <span class="badge on" id="defenseBadge">ON</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div class="page-title">控制台</div>
          <div class="page-sub">实时管理防御策略、封禁列表与统计概览</div>
        </div>
        <div class="main-actions">
          <a class="btn-ghost" href="{{ url_for('dashboard') }}">打开仪表盘</a>
          <a class="btn-ghost" href="{{ url_for('test_xss_page') }}">打开测试页</a>
        </div>
      </div>

      <div id="toastHost"></div>

      <div class="hero">
        <section class="card">
          <div class="card-inner">
            <div class="card-title">防御控制</div>
            <div class="form-row" style="align-items:center; justify-content:space-between;">
              <div>
                <div class="badge on" id="defenseStatus">开启</div>
                <div class="card-p">切换中间件策略开关（用于测试/演示）</div>
              </div>
              <div class="form-row" style="justify-content:flex-end;">
                <button id="defenseOn" class="btn btn-primary" type="button">开启防御</button>
                <button id="defenseOff" class="btn btn-warn" type="button">关闭防御</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="split">
        <section class="card">
          <div class="card-inner">
            <div class="card-title">IP 封禁管理</div>
            <div class="form-row">
              <input type="text" id="banIpInput" class="input" placeholder="输入要封禁的 IP">
              <button id="banBtn" class="btn btn-danger" type="button">永久封禁</button>
              <button id="unbanBtn" class="btn" type="button">解封</button>
              <button id="refreshBanned" class="btn" type="button">刷新列表</button>
            </div>
            <div class="card-p" style="margin-top:10px;">当前封禁列表</div>
            <div id="bannedList" class="banned-list">加载中...</div>
          </div>
        </section>

        <section class="card">
          <div class="card-inner">
            <div class="card-title">快速入口</div>
            <div class="grid">
              <a class="card" style="text-decoration:none;" href="{{ url_for('dashboard') }}">
                <div class="card-inner">
                  <div class="card-title">Dashboard</div>
                  <div class="card-h">仪表盘</div>
                  <div class="card-p">趋势图 / Top IP / 类型分布</div>
                </div>
              </a>
              <a class="card" style="text-decoration:none;" href="{{ url_for('test_xss_page') }}">
                <div class="card-inner">
                  <div class="card-title">XSS Lab</div>
                  <div class="card-h">测试页面</div>
                  <div class="card-p">提交 payload 验证防御</div>
                </div>
              </a>
            </div>
          </div>
        </section>
      </div>

      <div class="split" style="margin-top:14px;">
        <section class="card">
          <div class="card-inner">
            <div class="card-title">最近 14 天攻击趋势</div>
            <div class="chart-wrap">
              <canvas id="attackTrendChart"></canvas>
            </div>
          </div>
        </section>
        <section class="card">
          <div class="card-inner">
            <div class="card-title">Top 攻击来源 IP</div>
            <div class="chart-wrap">
              <canvas id="topIpChart"></canvas>
            </div>
          </div>
        </section>
      </div>
    </main>

    <aside class="rightbar">
      <div class="right-title">
        <h3>Global Chat</h3>
        <div class="online" id="onlineCount">-- online</div>
      </div>

      <div class="chat">
        <div class="chat-list" id="chatList">
          <div class="msg">
            <div class="msg-avatar">S</div>
            <div class="msg-bubble">
              <div class="msg-head">
                <div class="msg-name">System</div>
                <div class="msg-time">now</div>
              </div>
              <div class="msg-text">欢迎进入控制台。右侧是 UI 示例区，可按需接入真实消息源。</div>
            </div>
          </div>
        </div>
        <div class="chat-input">
          <input id="chatInput" class="input" placeholder="Type your message..." autocomplete="off">
          <button id="chatSend" class="btn btn-primary" type="button">Send</button>
        </div>
      </div>
    </aside>
  </div>

  <script>
    let attackChart, topIpChart;

    function toast(message, type) {
      const host = document.getElementById('toastHost');
      if (!host) return;
      const el = document.createElement('div');
      el.style.cssText = 'position:fixed;left:50%;top:16px;transform:translateX(-50%);z-index:9999;max-width:720px;width:calc(100% - 32px);';
      el.innerHTML = `
        <div class="alert alert-${type} shadow" role="alert" style="margin:0;border-radius:14px;">
          ${message}
        </div>
      `;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }

    // API 调用函数
    async function apiPost(path, payload) {
      const r = await fetch(path, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      return r;
    }

    async function apiGet(path) {
      const r = await fetch(path, { credentials: 'same-origin' });
      return r;
    }

    // 防御开关
    document.getElementById('defenseOn').addEventListener('click', async () => {
      const r = await apiPost('/toggle_defense', { enabled: true });
      const data = await r.json();
      updateDefenseStatus(data.enabled);
      toast('防御已开启', 'success');
    });

    document.getElementById('defenseOff').addEventListener('click', async () => {
      const r = await apiPost('/toggle_defense', { enabled: false });
      const data = await r.json();
      updateDefenseStatus(data.enabled);
      toast('防御已关闭', 'warning');
    });

    function updateDefenseStatus(enabled) {
      const badge = document.getElementById('defenseStatus');
      if (enabled) {
        badge.textContent = '开启';
        badge.className = 'badge on';
        const b2 = document.getElementById('defenseBadge');
        if (b2) { b2.textContent = 'ON'; b2.className = 'badge on'; }
      } else {
        badge.textContent = '关闭';
        badge.className = 'badge off';
        const b2 = document.getElementById('defenseBadge');
        if (b2) { b2.textContent = 'OFF'; b2.className = 'badge off'; }
      }
    }

    // IP 封禁
    document.getElementById('banBtn').addEventListener('click', async () => {
      const ip = document.getElementById('banIpInput').value.trim();
      if (!ip) return toast('请输入 IP 地址', 'danger');
      const r = await apiPost('/ban_ip', { ip, permanent: true });
      const data = await r.json();
      toast(data.status === 'ok' ? `已永久封禁 ${ip}` : '操作失败', data.status === 'ok' ? 'success' : 'danger');
      loadBannedList();
    });

    document.getElementById('unbanBtn').addEventListener('click', async () => {
      const ip = document.getElementById('banIpInput').value.trim();
      if (!ip) return toast('请输入 IP 地址', 'danger');
      const r = await apiPost('/unban_ip', { ip });
      const data = await r.json();
      toast(data.status === 'ok' ? `已解封 ${ip}` : '操作失败', data.status === 'ok' ? 'success' : 'danger');
      loadBannedList();
    });

    document.getElementById('refreshBanned').addEventListener('click', loadBannedList);

    // 加载封禁列表
    async function loadBannedList() {
      try {
        const r = await apiGet('/get_banned_ips');
        const list = await r.json();
        const el = document.getElementById('bannedList');
        if (list.length === 0) {
          el.innerHTML = '<div class="text-muted">当前无封禁 IP</div>';
        } else {
          el.innerHTML = list.map(item => {
            const type = item.permanent ? '永久' : `临时 (至 ${new Date(item.expires_at).toLocaleString()})`;
            return `<div style="padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.04);margin-bottom:8px;">
              <div style="display:flex;justify-content:space-between;gap:10px;">
                <div><strong>${item.ip}</strong></div>
                <div class="text-muted" style="font-size:11px;">${new Date(item.banned_at).toLocaleString()}</div>
              </div>
              <div class="text-muted" style="font-size:12px;">${type}</div>
            </div>`;
          }).join('');
        }
      } catch (e) {
        document.getElementById('bannedList').innerHTML = '<p class="text-danger">加载失败</p>';
      }
    }

    // 加载统计图表
    async function loadCharts() {
      try {
        // 攻击趋势
        const trendR = await apiGet('/api/stats/attacks');
        const trendData = await trendR.json();
        const ctx1 = document.getElementById('attackTrendChart').getContext('2d');
        if (attackChart) attackChart.destroy();
        attackChart = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: trendData.labels,
            datasets: [{
              label: '攻击次数',
              data: trendData.data,
              borderColor: '#ff6b6b',
              backgroundColor: 'rgba(255,107,107,0.1)',
              tension: 0.3
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });

        // Top IP
        const ipR = await apiGet('/api/stats/top_ips');
        const ipData = await ipR.json();
        const ctx2 = document.getElementById('topIpChart').getContext('2d');
        if (topIpChart) topIpChart.destroy();
        topIpChart = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: ipData.labels,
            datasets: [{
              label: '攻击次数',
              data: ipData.data,
              backgroundColor: '#6bc1ff'
            }]
          },
          options: { 
            indexAxis: 'y',
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
      } catch (e) {
        console.error('加载图表失败:', e);
      }
    }

    // 页面加载时初始化
    window.addEventListener('load', () => {
      loadBannedList();
      loadCharts();
      updateDefenseStatus(true);
      // 每30秒自动刷新
      setInterval(() => {
        loadBannedList();
        loadCharts();
      }, 30000);
    });
  </script>

  <script>
    async function loadBrandMark() {
      try {
        const response = await fetch('/get_current_mascot');
        const data = await response.json();
        const el = document.getElementById('brandMark');
        if (el && data.mascot_url) {
          el.style.backgroundImage = `url('${data.mascot_url}')`;
        }
      } catch (e) {
      }
    }

    function initChatMock() {
      const online = document.getElementById('onlineCount');
      if (online) {
        const n = 900 + Math.floor(Math.random() * 800);
        online.textContent = n.toLocaleString() + ' online';
      }
      const send = document.getElementById('chatSend');
      const input = document.getElementById('chatInput');
      const list = document.getElementById('chatList');
      if (!send || !input || !list) return;
      const push = (name, text) => {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2,'0');
        const mm = String(now.getMinutes()).padStart(2,'0');
        const wrapper = document.createElement('div');
        wrapper.className = 'msg';
        wrapper.innerHTML = `
          <div class="msg-avatar">${name.slice(0,1).toUpperCase()}</div>
          <div class="msg-bubble">
            <div class="msg-head">
              <div class="msg-name">${name}</div>
              <div class="msg-time">${hh}:${mm}</div>
            </div>
            <div class="msg-text"></div>
          </div>
        `;
        wrapper.querySelector('.msg-text').textContent = text;
        list.appendChild(wrapper);
        list.scrollTop = list.scrollHeight;
      };
      send.addEventListener('click', () => {
        const v = input.value.trim();
        if (!v) return;
        push('You', v);
        input.value = '';
        setTimeout(() => push('Guardian', '已收到。你可以把这里接入真实消息源。'), 500);
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') send.click();
      });
    }

    loadBrandMark();
    initChatMock();
  </script>

  <script>
    (function initFlipFx(){
      const wav = '/static/audio/%E7%BF%BB%E4%B9%A6%20_%E7%BF%BB%E4%B9%A615_Freesound.wav';
      const flipAudio = new Audio(wav);
      flipAudio.preload = 'auto';
      flipAudio.volume = 0.6;

      try { flipAudio.load(); } catch (e) {}

      let last = 0;
      document.addEventListener('click', (e) => {
        if (localStorage.getItem('soundEnabled') !== '1') return;
        const now = Date.now();
        if (now - last < 140) return;
        last = now;
        try { flipAudio.currentTime = 0; } catch (e) {}
        flipAudio.play().catch(() => {});
      }, true);
    })();
  </script>
</body>
</html>